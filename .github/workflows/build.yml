name: PyStand

on: [ push, pull_request ]

env:
  PYSTAND_VERSION: v1.0.6
  BUILD_TYPE: Release

jobs:
  build-msvc:
    if: >-
      ! contains(toJSON(github.event.commits.*.message), '[skip ci]')

    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - { generator: Visual Studio 17 2022, arch: Win32, subsystem: GUI }
          - { generator: Visual Studio 17 2022, arch: Win32, subsystem: CLI }
          - { generator: Visual Studio 17 2022, arch: x64, subsystem: GUI }
          - { generator: Visual Studio 17 2022, arch: x64, subsystem: CLI }

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure
      run: |
        if ( '${{ matrix.subsystem }}' -eq 'GUI' )
        {
          cmake -G "${{ matrix.generator }}" -A ${{ matrix.arch }} -B build -DPYSTAND_CONSOLE=OFF
        }
        else
        {
          cmake -G "${{ matrix.generator }}" -A ${{ matrix.arch }} -B build -DPYSTAND_CONSOLE=ON
        }

    - name: Build
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: PyStand-${{ env.PYSTAND_VERSION }}-${{ matrix.arch }}-${{ matrix.subsystem }}
        path: build/${{ env.BUILD_TYPE }}

  build-gcc:
    if: >-
      ! contains(toJSON(github.event.commits.*.message), '[skip ci]')

    runs-on: ubuntu-latest

    defaults:
      run:
        shell: msys2 {0}

    strategy:
      fail-fast: true
      matrix:
        include:
          - { msystem: MINGW32, arch: i686, subsystem: GUI }
          - { msystem: MINGW32, arch: i686, subsystem: CLI }
          - { msystem: MINGW64, arch: x86_64, subsystem: GUI }
          - { msystem: MINGW64, arch: x86_64, subsystem: CLI }

    steps:
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        install: >-
          base-devel
          cmake
          mingw-w64-${{ matrix.arch }}-toolchain

    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure
      run: |
        export MSYSTEM="${{ matrix.msystem }}"
        echo "MSYSTEM=$MSYSTEM"
        PYSTAND_CONSOLE="OFF"
        if [ "${{ matrix.subsystem }}" == "CLI" ]; then
          PYSTAND_CONSOLE="ON"
        fi      
        cmake -B build -DPYSTAND_CONSOLE=$PYSTAND_CONSOLE -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_TOOLCHAIN_FILE=./cmake/mingw-w64-${{ matrix.arch }}.cmake

    - name: Build
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: PyStand-${{ env.PYSTAND_VERSION }}-${{ matrix.msystem }}-${{ matrix.subsystem }}
        path: build/PyStand.exe

  release:
    needs: [ build-msvc, build-gcc ]

    runs-on: windows-latest

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3

    - name: List downloaded files
      run: ls -R

    - name: Create archives
      run: |
        7z a PyStand-${{ env.PYSTAND_VERSION }}-Win32-CLI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-Win32-CLI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-Win32-GUI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-Win32-GUI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-x64-CLI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-x64-CLI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-x64-GUI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-x64-GUI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-mingw32-CLI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-mingw32-CLI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-mingw32-GUI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-mingw32-GUI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-mingw64-CLI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-mingw64-CLI\*
        7z a PyStand-${{ env.PYSTAND_VERSION }}-mingw64-GUI.zip .\PyStand-${{ env.PYSTAND_VERSION }}-mingw64-GUI\*

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        generate_release_notes: true
        files: |
          PyStand*.zip
